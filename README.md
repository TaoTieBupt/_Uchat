# _Uchat
安全即时通讯系统
# Uchat - 一款功能完备的即时通讯软件

![Uchat-logo](https://img.shields.io/badge/Uchat-v1.0-blue)
![Python-version](https://img.shields.io/badge/Python-3.8%2B-green)
![License-MIT](https://img.shields.io/badge/License-MIT-brightgreen)

**Uchat** 是一个基于Python技术栈从零开始构建的、功能丰富的即时通讯（IM）桌面应用。它采用经典的客户端/服务器架构，实现了安全通信、实时聊天、好友与群组管理、朋友圈动态、文件传输和语音通话等一系列核心功能。

## ✨ 核心功能 (Features)

*   **安全通信**:
    *   客户端与服务器之间的所有通信都经过 **DH密钥交换** 和 **AES-256-CBC** 加密，确保消息机密性。
    *   通过MD5摘要保证消息的完整性，防止数据篡改。
*   **基础聊天**:
    *   支持一对一**私聊**和多对多**群聊**。
    *   支持发送**文本、图片、文件**。
    *   支持**离线消息**存储与上线后拉取。
*   **实时语音通话**:
    *   支持基于**PyAudio**的实时点对点语音通话（通过服务器中转）。
    *   完整的通话信令流程：呼叫、接听、拒接、挂断。
*   **社交功能**:
    *   **好友系统**: 添加好友、删除好友、好友请求处理。
    *   **在线状态**实时同步。
    *   **朋友圈动态**: 发布文本动态，查看好友动态，并支持**点赞和评论**。
*   **群组管理**:
    *   **群主权限**: 群主可以**邀请好友入群**和**将成员移出群聊**。
    *   **成员操作**: 普通成员可以**主动退出群聊**。
*   **个人资料**:
    *   支持用户自定义**头像**和**个性签名**。
    *   好友之间的头像和资料更新可实时同步。

## 🛠️ 技术栈 (Tech Stack)

*   **后端 (Server)**:
    *   **语言**: Python 3
    *   **并发模型**: `socket` + `select` (I/O多路复用)
    *   **数据库**: SQLite 3 (轻量级文件数据库)
*   **前端 (Client)**:
    *   **GUI框架**: `tkinter` (Python标准库)
    *   **图像处理**: `Pillow` (PIL Fork)
    *   **音频处理**: `PyAudio`
*   **通用 (Common)**:
    *   **加密库**: `cryptography`
    *   **数据序列化**: 自定义二进制协议 + `json`

## 🚀 运行指南 (Getting Started)

在运行项目之前，请确保您的系统已安装 **Python 3.8 或更高版本**。

### 1. 克隆或下载项目

将项目代码下载到本地。

### 2. 创建虚拟环境并安装依赖

在项目的根目录 (即 `Uchat/` 目录下) 打开终端，然后执行以下步骤：

```bash
# 1. 创建一个名为 .venv 的虚拟环境
python -m venv .venv

# 2. 激活虚拟环境
#    Windows:
.venv\Scripts\activate
#    macOS / Linux:
#    source .venv/bin/activate

# 3. 安装所有必需的依赖库
pip install -r requirements.txt
```
> **注意**: `pyaudio` 库在Windows上可能需要手动安装。请参考其官方文档或使用预编译的wheel包。

### 3. 初始化数据库和文件目录

*   **数据库**: 首次运行服务器时，`database.db` 文件会自动在 `server/` 目录下创建。如果修改了 `server/main.sql` 中的表结构，请**手动删除旧的 `database.db` 文件**后重启服务器。
*   **文件目录**: 请确保以下目录存在，如果不存在，请手动创建：
    *   `server/uploaded_files/`  (用于存放用户上传的头像、图片和文件)
    *   `client/image_cache/`     (客户端用于临时缓存图片)
    *   `client/file_cache/`      (客户端用于临时缓存文件)

### 4. 运行程序

您需要打开**至少两个**终端来模拟客户端之间的交互。

**终端 1: 启动服务器**

```bash
# 确保你位于 Uchat/ 根目录并已激活虚拟环境
python run_server.py
```
您应该会看到类似 "服务器已启动..." 的日志。**请保持此终端窗口运行。**

**终端 2 (及更多): 启动客户端**

```bash
# 确保你位于 Uchat/ 根目录并已激活虚拟环境
python run_client.py
```
将会弹出一个登录窗口。您可以：
1.  点击 **【注册】** 创建一个新用户 (例如 `userA`)。
2.  使用新账户登录。
3.  打开另一个终端，重复此步骤，创建并登录另一个用户 (例如 `userB`)。
4.  现在，`userA` 和 `userB` 就可以互相添加好友并开始测试所有功能了！

## 🌟 架构亮点 (Architecture Highlights)

*   **事件驱动设计**: 服务器采用`select`模型，将网络I/O与业务逻辑完全分离。`event_handler`作为中央分发器，使得添加新功能变得异常简单。
*   **职责分离**: `client`, `server`, `common` 三大模块各司其职。后端进一步细分为数据层、逻辑层、内存层，代码结构清晰，高度解耦。
*   **健壮的网络层**: 封装了`SecureChannel`和`recv_all`函数，从根本上解决了TCP粘包/半包问题，并自动处理了数据的加解密，让上层业务逻辑无需关心底层细节。
*   **流畅的客户端体验**: 采用**后台线程**处理所有网络通信，并通过`tk.after()`机制安全地更新UI，确保了即使用户网络卡顿，图形界面也绝不会冻结。
*   **中心化配置**: 通过`server/config.py`管理共享配置，有效避免了因模块间交叉引用导致的循环导入问题。

---
**祝您使用愉快！**
